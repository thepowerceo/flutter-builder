name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Download and extract source
        run: |
          SOURCE_URL="${{ github.event.client_payload.source_url }}"
          
          # Convert GitHub repo URL to ZIP download URL if needed
          if [[ "$SOURCE_URL" == https://github.com/* && ! "$SOURCE_URL" == *.zip ]]; then
            REPO_PATH="${SOURCE_URL#https://github.com/}"
            SOURCE_URL="https://github.com/${REPO_PATH}/archive/refs/heads/main.zip"
          fi
          
          curl -L -o source.zip "$SOURCE_URL"
          unzip source.zip -d source_temp
          
          # Flatten: move contents up if there's a single wrapper directory
          shopt -s dotglob
          if [ $(ls -1 source_temp | wc -l) -eq 1 ] && [ -d "source_temp/$(ls source_temp)" ]; then
            mv source_temp/*/* ./flutter_project/ 2>/dev/null || mv source_temp/*/.* ./flutter_project/ 2>/dev/null || true
            mkdir -p flutter_project
            mv source_temp/*/* flutter_project/ 2>/dev/null || true
          else
            mv source_temp flutter_project
          fi
          
          rm -rf source_temp source.zip

      - name: Generate web support if missing
        working-directory: flutter_project
        run: |
          if [ ! -f "web/index.html" ]; then
            # Extract package name from pubspec.yaml
            PACKAGE_NAME=$(grep "^name:" pubspec.yaml | sed 's/name: *//' | tr -d '\r\n' | xargs)
            flutter create --platforms=web --project-name="$PACKAGE_NAME" .
          fi

      - name: Install dependencies
        working-directory: flutter_project
        run: flutter pub get

      - name: Build for web
        working-directory: flutter_project
        run: flutter build web --release --base-href "/${{ github.event.client_payload.project_id }}/"

      - name: Upload to Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PROJECT_ID: ${{ github.event.client_payload.project_id }}
        run: |
          cd flutter_project/build/web
          
          # Upload each file to Supabase Storage
          find . -type f | while read file; do
            relative_path="${file#./}"
            mime_type=$(file -b --mime-type "$file")
            
            echo "Uploading: $relative_path ($mime_type)"
            
            curl -X POST "${SUPABASE_URL}/storage/v1/object/flutter-compiled/${PROJECT_ID}/${relative_path}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Content-Type: ${mime_type}" \
              --data-binary @"$file" \
              --fail --silent --show-error
          done
          
          echo "All files uploaded successfully"

      - name: Notify build success
        if: success()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          PROJECT_ID: ${{ github.event.client_payload.project_id }}
        run: |
          COMPILED_URL="${SUPABASE_URL}/storage/v1/object/public/flutter-compiled/${PROJECT_ID}/index.html"
          
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"project_id\": \"${PROJECT_ID}\", \"status\": \"completed\", \"compiled_url\": \"${COMPILED_URL}\"}"

      - name: Notify build failure
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"project_id\": \"${{ github.event.client_payload.project_id }}\", \"status\": \"failed\", \"error_message\": \"Build failed - check GitHub Actions logs\"}"
