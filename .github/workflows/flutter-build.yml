name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Download and extract source
        shell: bash
        run: |
          echo "=== Build payload ==="
          echo "Project ID: ${{ github.event.client_payload.project_id }}"
          echo "Source type: ${{ github.event.client_payload.source_type }}"
          echo "Source URL: ${{ github.event.client_payload.source_url }}"
          
          if [ "${{ github.event.client_payload.source_type }}" == "github" ]; then
            curl -L -o source.zip "${{ github.event.client_payload.source_url }}"
          else
            curl -L -o source.zip "${{ github.event.client_payload.storage_url }}"
          fi
          
          unzip -q source.zip
          
          # Flatten if extracted into subdirectory
          shopt -s dotglob
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d ! -name "." ! -name ".git" | head -1)
          if [ -n "$EXTRACTED_DIR" ] && [ -d "$EXTRACTED_DIR" ] && [ -f "$EXTRACTED_DIR/pubspec.yaml" ]; then
            echo "Moving contents from $EXTRACTED_DIR to root"
            mv "$EXTRACTED_DIR"/* . 2>/dev/null || true
            rm -rf "$EXTRACTED_DIR"
          fi
          
          echo "=== Directory contents ==="
          ls -la

      - name: Verify Flutter project
        shell: bash
        run: |
          if [ ! -f "pubspec.yaml" ]; then
            echo "ERROR: pubspec.yaml not found!"
            find . -name "pubspec.yaml" -type f
            exit 1
          fi
          echo "pubspec.yaml found"
          cat pubspec.yaml | head -20

      - name: Ensure web platform exists
        shell: bash
        run: |
          if [ -f "web/index.html" ]; then
            echo "web/index.html found"
          else
            echo "web/index.html MISSING -> creating web scaffolding..."
            flutter create . --platforms=web
          fi
          echo "=== web/ contents ==="
          ls -la web

      - name: Build Flutter web
        run: |
          flutter config --no-analytics
          flutter pub get
          flutter build web --release
          echo "=== Build output ==="
          ls -la build/web

      - name: Upload to Supabase Storage
        shell: bash
        run: |
          cd build/web
          zip -r ../../compiled.zip .
          cd ../..
          
          COMPILED_URL=$(curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/flutter-compiled/${{ github.event.client_payload.project_id }}/app.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/zip" \
            --data-binary @compiled.zip \
            --fail \
            -w "\n%{http_code}" | tail -1)
          
          echo "Upload response code: $COMPILED_URL"
          echo "COMPILED_URL=${{ secrets.SUPABASE_URL }}/storage/v1/object/public/flutter-compiled/${{ github.event.client_payload.project_id }}/app.zip" >> $GITHUB_ENV

      - name: Notify completion
        if: success()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "completed",
              "compiled_url": "${{ env.COMPILED_URL }}"
            }'

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "failed",
              "error_message": "Build failed - check GitHub Actions logs"
            }'
