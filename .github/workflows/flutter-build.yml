name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Download and extract source
        shell: bash
        run: |
          echo "=== Build payload ==="
          echo "Project ID: ${{ github.event.client_payload.project_id }}"
          echo "Source type: ${{ github.event.client_payload.source_type }}"
          echo "Source URL: ${{ github.event.client_payload.source_url }}"
          
          if [ "${{ github.event.client_payload.source_type }}" == "github" ]; then
            # Convert repo URL to archive URL
            REPO_URL="${{ github.event.client_payload.source_url }}"
            # Remove trailing slash if present
            REPO_URL="${REPO_URL%/}"
            # Try to detect if it's already an archive URL
            if [[ "$REPO_URL" == *"/archive/"* ]]; then
              ARCHIVE_URL="$REPO_URL"
            else
              # Default to main branch, fallback to master
              ARCHIVE_URL="${REPO_URL}/archive/refs/heads/main.zip"
            fi
            echo "Archive URL: $ARCHIVE_URL"
            
            HTTP_CODE=$(curl -L -o source.zip -w "%{http_code}" "$ARCHIVE_URL")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "main branch failed, trying master..."
              ARCHIVE_URL="${REPO_URL}/archive/refs/heads/master.zip"
              curl -L -o source.zip "$ARCHIVE_URL" --fail
            fi
          else
            curl -L -o source.zip "${{ github.event.client_payload.storage_url }}" --fail
          fi
          
          echo "=== Downloaded file info ==="
          file source.zip
          ls -la source.zip
          
          unzip -q source.zip
          
          # Flatten if extracted into subdirectory
          shopt -s dotglob
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d ! -name "." ! -name ".git" | head -1)
          if [ -n "$EXTRACTED_DIR" ] && [ -d "$EXTRACTED_DIR" ] && [ -f "$EXTRACTED_DIR/pubspec.yaml" ]; then
            echo "Moving contents from $EXTRACTED_DIR to root"
            mv "$EXTRACTED_DIR"/* . 2>/dev/null || true
            rm -rf "$EXTRACTED_DIR"
          fi
          
          echo "=== Directory contents ==="
          ls -la

      - name: Verify Flutter project
        shell: bash
        run: |
          if [ ! -f "pubspec.yaml" ]; then
            echo "ERROR: pubspec.yaml not found!"
            find . -name "pubspec.yaml" -type f
            exit 1
          fi
          echo "pubspec.yaml found"

      - name: Ensure web platform exists
        shell: bash
        run: |
          if [ -f "web/index.html" ]; then
            echo "web/index.html found"
          else
            echo "Creating web scaffolding..."
            flutter create . --platforms=web
          fi

      - name: Build Flutter web
        run: |
          flutter config --no-analytics
          flutter pub get
          flutter build web --release

      - name: Upload to Supabase Storage
        shell: bash
        run: |
          cd build/web
          zip -r ../../compiled.zip .
          cd ../..
          
          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/flutter-compiled/${{ github.event.client_payload.project_id }}/app.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/zip" \
            --data-binary @compiled.zip \
            --fail
          
          echo "COMPILED_URL=${{ secrets.SUPABASE_URL }}/storage/v1/object/public/flutter-compiled/${{ github.event.client_payload.project_id }}/app.zip" >> $GITHUB_ENV

      - name: Notify completion
        if: success()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "completed",
              "compiled_url": "${{ env.COMPILED_URL }}"
            }'

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "failed",
              "error_message": "Build failed - check GitHub Actions logs"
            }'
