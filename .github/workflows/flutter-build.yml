name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Download source
        shell: bash
        run: |
          set -euo pipefail

          SOURCE_URL="${{ github.event.client_payload.source_url }}"
          if [ -n "${SOURCE_URL:-}" ]; then
            curl -L -o source.zip "${SOURCE_URL}/archive/refs/heads/main.zip" || \
              curl -L -o source.zip "${SOURCE_URL}/archive/refs/heads/master.zip"

            unzip -q source.zip

            # Move extracted repo contents into workspace root
            shopt -s dotglob
            mv *-main/* . 2>/dev/null || mv *-master/* . 2>/dev/null || true
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"
          channel: "stable"

      - name: Enable Web Support
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "web/index.html" ]; then
            APP_NAME="$(awk -F: '/^name[[:space:]]*:/ {gsub(/[[:space:]]/, "", $2); print $2; exit}' pubspec.yaml 2>/dev/null || true)"
            APP_NAME="${APP_NAME:-app}"
            APP_NAME="$(echo "$APP_NAME" | tr '-' '_' | tr -cd 'a-zA-Z0-9_')"
            if [[ ! "$APP_NAME" =~ ^[A-Za-z_] ]]; then APP_NAME="_${APP_NAME}"; fi

            flutter create . --platforms=web --project-name="$APP_NAME"
          fi

      - name: Build Flutter Web
        shell: bash
        run: |
          set -euo pipefail

          flutter pub get

          BASE_HREF="${{ github.event.client_payload.base_href }}"
          if [ -z "${BASE_HREF:-}" ]; then
            BASE_HREF="${{ github.event.client_payload.baseHref }}"
          fi
          if [ -z "${BASE_HREF:-}" ]; then
            BASE_HREF="/storage/v1/object/public/flutter-compiled/${{ github.event.client_payload.project_id }}/"
          fi

          if [[ "$BASE_HREF" != /*/ ]]; then
            echo "Invalid BASE_HREF='$BASE_HREF' (must start and end with '/')" >&2
            exit 1
          fi

          echo "Building with BASE_HREF=$BASE_HREF"
          flutter build web --release --base-href "$BASE_HREF"

      - name: Report Success
        if: success()
        shell: bash
        run: |
          set -euo pipefail

          cd build/web
          zip -r ../../build.zip .
          cd ../..

          curl -sS -X POST "${{ github.event.client_payload.callback_url }}" \
            -F "project_id=${{ github.event.client_payload.project_id }}" \
            -F "status=completed" \
            -F "file=@build.zip"

      - name: Report Failure
        if: failure()
        shell: bash
        run: |
          set -euo pipefail

          curl -sS -X POST "${{ github.event.client_payload.callback_url }}" \
            -F "project_id=${{ github.event.client_payload.project_id }}" \
            -F "status=failed" \
            -F "error_message=GitHub Actions build failed" || true
