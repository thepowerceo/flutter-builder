name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Download source
        run: |
          SOURCE_URL="${{ github.event.client_payload.source_url }}"
          if [ -n "$SOURCE_URL" ]; then
            ZIP_URL=$(echo "$SOURCE_URL" | sed 's|github.com/|github.com/|;s|$|/archive/refs/heads/main.zip|')
            curl -L -o source.zip "$ZIP_URL" || curl -L -o source.zip "${SOURCE_URL}/archive/refs/heads/master.zip"
            unzip source.zip
            shopt -s dotglob && mv *-main/* . 2>/dev/null || mv *-master/* . 2>/dev/null || true
          fi

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      # ðŸ‘‡ ADD THIS STEP - generates web support if missing
      - name: Enable Web Support
        run: |
          if [ ! -f "web/index.html" ]; then
            APP_NAME=$(grep '^name:' pubspec.yaml | sed 's/name: //' | tr -d '[:space:]' | tr '-' '_')
            echo "Generating web scaffolding for: $APP_NAME"
            flutter create . --platforms=web --project-name="$APP_NAME"
          fi

      - name: Build Flutter Web
        run: |
          flutter pub get
          flutter build web --release --base-href "/"

      - name: Report Success
        if: success()
        run: |
          cd build/web && zip -r ../../build.zip . && cd ../..
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -F "project_id=${{ github.event.client_payload.project_id }}" \
            -F "status=completed" \
            -F "file=@build.zip"

      - name: Report Failure
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -F "project_id=${{ github.event.client_payload.project_id }}" \
            -F "status=failed" \
            -F "error_message=Build failed"
