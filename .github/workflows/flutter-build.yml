name: Flutter Web Build

on:
  repository_dispatch:
    types: [flutter_build]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Disable Flutter analytics
        run: flutter config --no-analytics

      - name: Download source
        run: |
          echo "=== Build payload ==="
          echo "Project ID: ${{ github.event.client_payload.project_id }}"
          echo "Source type: ${{ github.event.client_payload.source_type }}"
          echo "Source URL: ${{ github.event.client_payload.source_url }}"
          
          if [ "${{ github.event.client_payload.source_type }}" == "github" ]; then
            REPO_URL="${{ github.event.client_payload.source_url }}"
            REPO_URL="${REPO_URL%/}"
            
            # Convert repo URL to archive URL if needed
            if [[ "$REPO_URL" == *"/archive/"* ]]; then
              ARCHIVE_URL="$REPO_URL"
            else
              ARCHIVE_URL="${REPO_URL}/archive/refs/heads/main.zip"
            fi
            
            echo "Trying archive URL: $ARCHIVE_URL"
            HTTP_CODE=$(curl -L -o source.zip -w "%{http_code}" "$ARCHIVE_URL")
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "main branch not found (HTTP $HTTP_CODE), trying master..."
              ARCHIVE_URL="${REPO_URL}/archive/refs/heads/master.zip"
              curl -L -o source.zip "$ARCHIVE_URL" --fail
            fi
          else
            curl -L -o source.zip "${{ github.event.client_payload.source_url }}" --fail
          fi
          
          ls -la source.zip
          unzip -q source.zip
          
          # Flatten directory structure
          shopt -s dotglob
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "*-main" -o -name "*-master" | head -1)
          if [ -n "$EXTRACTED_DIR" ] && [ "$EXTRACTED_DIR" != "." ]; then
            echo "Flattening directory: $EXTRACTED_DIR"
            mv "$EXTRACTED_DIR"/* .
            rmdir "$EXTRACTED_DIR"
          fi
          
          echo "=== Project structure ==="
          ls -la
          
          if [ ! -f "pubspec.yaml" ]; then
            echo "ERROR: pubspec.yaml not found!"
            exit 1
          fi

      - name: Ensure web platform exists
        run: |
          if [ ! -f "web/index.html" ]; then
            echo "Creating web scaffolding..."
            
            # Extract app name from pubspec.yaml
            APP_NAME=$(grep -m1 '^name:' pubspec.yaml | awk '{print $2}' | tr -d '\r')
            echo "Extracted app name: $APP_NAME"
            
            if [ -z "$APP_NAME" ]; then
              echo "Could not extract app name, using default"
              APP_NAME="flutter_app"
            fi
            
            # Create web platform with correct project name
            flutter create . --platforms=web --project-name="$APP_NAME"
          else
            echo "Web platform already exists"
          fi

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release --base-href "/"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-web-build
          path: build/web/
          retention-days: 7

      - name: Notify success
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/build-callback" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "completed",
              "compiled_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/build-callback" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d '{
              "project_id": "${{ github.event.client_payload.project_id }}",
              "status": "failed",
              "error_message": "Build failed - check workflow logs"
            }'
